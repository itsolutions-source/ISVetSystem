<div class="card container-card">
  <p class="font-bold text-3xl text-center">Retirada de Medicamentos</p>
  <p class="text-center mb-4 text-xl">
    Escaneie os medicamentos para adicion√°-los √† lista
  </p>
  <div class="input-group">
    <!-- Campo invis√≠vel ou vis√≠vel, tanto faz -->
    <!-- <input
  #scannerInput
  type="text"
  (keydown)="handleKey($event)"
  autocomplete="off"
  class="opacity-0 absolute pointer-events-none"
/> -->

    <input
      class="barcode"
      #scannerInput
      type="text"
      pInputText
      autocomplete="off"
      placeholder="Digite c√≥digo de barras ou nome"
      [(ngModel)]="barcodeInput"
      (keydown)="handleKey($event)"
    />
    <button
      pButton
      type="submit"
      icon="pi pi-plus"
      (click)="onScan(barcodeInput)"
    >
      Adicionar
    </button>
    <button
      pButton
      icon="pi pi-camera"
      class="p-button-info"
      (click)="startScanner()"
    >
      Ler com C√¢mera
    </button>
  </div>

  @if (medications().length > 0) {
  <div class="mt-3">
    <p-table
      [value]="medications()"
      stripedRows
      [tableStyle]="{ 'min-width': '45rem' }"
      [rowHover]="true"
    >
      <ng-template #header>
        <tr>
          <th class="w-1/5 sm:w-[16%]">C√≥digo</th>
          <th class="w-1/2 sm:w-[57%]">Medica√ß√£o</th>
          <th class="w-1/5 sm:w-[17%]">Quantidade</th>
          <th class="w-1/5 sm:w-[10%]"></th>
        </tr>
      </ng-template>
      <ng-template #body let-medication let-index="rowIndex">
        <tr>
          <td>
            <p>{{ medication.barcode }}</p>
          </td>
          <td>
            @if (medication.name === 'Medica√ß√£o n√£o encontrada') {
            <p-tag value="C√≥digo n√£o encontrado" severity="danger"></p-tag>
            <div class="mt-2">
              <button
                pButton
                icon="pi pi-list"
                label="Selecionar Produto"
                class="p-button-sm p-button-info mt-2"
                (click)="openManualSelection(medication)"
              ></button>
            </div>

            } @else {
            <p>{{ medication.name }}</p>
            }
          </td>
          <td
            [pEditableColumn]="medication.quantity"
            pEditableColumnField="quantity"
          >
            <p-cellEditor>
              <ng-template #input #output>
                <p-inputnumber
                  [inputStyle]="{
                    width: isMobile() ? '3rem' : '3.5rem',
                  }"
                  [(ngModel)]="medication.quantity"
                  [showButtons]="true"
                  buttonLayout="horizontal"
                  inputId="horizontal"
                  spinnerMode="horizontal"
                  [step]="1"
                >
                  <ng-template #incrementbuttonicon>
                    <span class="pi pi-plus"></span>
                  </ng-template>
                  <ng-template #decrementbuttonicon>
                    <span class="pi pi-minus"></span>
                  </ng-template>
                </p-inputnumber>
              </ng-template>
            </p-cellEditor>
          </td>

          <td>
            <p-button
              icon="pi pi-trash"
              severity="danger"
              [rounded]="true"
              [outlined]="true"
              title="Remover"
              (click)="cancelAllFromBarcode(medication.barcode)"
            ></p-button>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>
  } @else {
  <div class="mt-8">
    <p-divider type="dashed" />
    <p class="font-semibold text-xl text-center">
      Aguardando leitura de c√≥digo de barras.
    </p>
  </div>
  }
</div>

<p-dialog
  [(visible)]="scan"
  [modal]="true"
  [breakpoints]="{ '1199px': '75vw', '768px': '90vw', '575px': '90vw' }"
  [style]="{ width: '70vw' }"
  [draggable]="false"
  [resizable]="false"
  [dismissableMask]="true"
  [closeOnEscape]="true"
  header="Leitor de C√≥digo de Barras"
  (onHide)="stopScanner()"
>
  <p-floatlabel class="w-full md:w-56 mt-2 mb-2" variant="on">
    <p-select
      [(ngModel)]="selectedCamera"
      inputId="on_label"
      [options]="cameras"
      optionLabel="label"
      (onChange)="onCameraChange()"
      class="w-full"
    />
    <label for="on_label">Selecionar c√¢mera</label>
  </p-floatlabel>

  <div class="relative w-full h-[calc(100vh-20rem)] bg-black rounded-xl">
    <video
      #video
      autoplay
      muted
      playsinline
      class="w-full h-full object-cover"
    ></video>

    <!-- <div
      class="absolute bottom-1 left-1/2 -translate-x-1/2 bg-black/60 text-white text-center py-3 text-lg rounded-xl w-[calc(100%-1rem)] sm:w-[calc(100%-3rem)] md:w-1/2 max-w-full"
    >
      üì¶ C√≥digo lido: <strong>{{ codeResult || "Aguardando..." }}</strong>
    </div> -->
  </div>
</p-dialog>

<p-dialog
  [(visible)]="productSelectVisible"
  [modal]="true"
  [style]="{ width: '60rem', maxWidth: '95vw' }"
  [breakpoints]="{ '1199px': '75vw', '768px': '90vw', '575px': '95vw' }"
  header="Selecionar produto"
  [dismissableMask]="true"
  [closeOnEscape]="true"
>
  <div class="mb-3 flex items-center gap-2">
    <p-floatlabel class="w-full md:w-96">
      <input
        #searchProductsInput
        pInputText
        id="searchProducts"
        class="w-full"
        placeholder="Buscar por nome ou c√≥digo"
        [(ngModel)]="productSearch"
        (input)="filterProducts()"
        (keydown.enter)="confirmIfSingleResult()"
      />
      <label for="searchProducts">Buscar</label>
    </p-floatlabel>

    <p-button
      icon="pi pi-times"
      label="Limpar"
      severity="secondary"
      (click)="clearProductSearch()"
    />

    <p-button
      icon="pi pi-plus"
      label="Cadastrar novo"
      (click)="toggleNewProduct(true)"
    />
  </div>

  @if (showNewProductForm) {
  <div class="p-3 border rounded-lg mb-3">
    <div class="text-sm opacity-80 mb-2">
      Dica: informe um <strong>nome</strong> (m√≠n. 4 letras). O
      <strong>c√≥digo de barras</strong> √© opcional. Este cadastro r√°pido
      registra apenas nome e c√≥digo de barras. Para finalizar o cadastro
      (unidade, fabricante, lote, validade, estoque etc.), acesse
      <strong>Estoque &gt; Cadastro de produtos.</strong>
    </div>

    <div class="flex flex-col md:flex-row gap-8 mt-8">
      <p-floatlabel class="w-full">
        <input
          pInputText
          id="newProdName"
          class="w-full"
          placeholder="Nome da medica√ß√£o"
          [(ngModel)]="newProduct.name"
          [ngClass]="{ 'p-invalid': newProductErrors.name }"
          (input)="validateNewProduct()"
        />
        <label for="newProdName">Nome*</label>
      </p-floatlabel>

      <p-floatlabel class="w-full md:w-84">
        <input
          pInputText
          id="newProdBarcode"
          class="w-full"
          placeholder="C√≥digo de barras (opcional)"
          [(ngModel)]="newProduct.barcode"
          [ngClass]="{ 'p-invalid': newProductErrors.barcode }"
          (input)="validateNewProduct()"
        />
        <label for="newProdBarcode">C√≥digo de barras</label>
      </p-floatlabel>
    </div>

    <div class="mt-2 text-red-500 text-sm space-y-1">
      @if (newProductErrors.name) {
      <div>‚Ä¢ Nome deve ter pelo menos 4 caracteres.</div>
      } @if (newProductErrors.barcodeExists) {
      <div>‚Ä¢ J√° existe um produto com esse c√≥digo.</div>
      } @if (newProductErrors.nameExists) {
      <div class="flex items-center gap-2">
        <span
          >‚Ä¢ J√° existe um produto com esse nome. Voc√™ pode reaproveit√°-lo.</span
        >
        <p-button
          text
          size="small"
          icon="pi pi-search"
          label="Localizar existente"
          (click)="goToSearchExisting()"
        />
      </div>
      }
    </div>

    <div class="mt-3 flex gap-2 justify-end">
      <p-button
        label="Cancelar"
        severity="secondary"
        (click)="toggleNewProduct(false)"
      />
      <p-button
        label="Salvar e usar"
        icon="pi pi-check"
        [disabled]="!canSaveNewProduct"
        (click)="saveNewProductAndUse()"
      />
    </div>
  </div>
  }

  <p-table
    [value]="filteredProducts"
    [paginator]="true"
    [rows]="10"
    [rowsPerPageOptions]="[5, 10, 20]"
    [rowHover]="true"
    [metaKeySelection]="false"
    selectionMode="single"
    [(selection)]="selectedProduct"
    (onRowSelect)="confirmSelectProduct()"
    [tableStyle]="{ 'min-width': '30rem' }"
  >
    <ng-template #header>
      <tr>
        <th style="width: 25%">C√≥digo</th>
        <th style="width: 75%">Medica√ß√£o</th>
      </tr>
    </ng-template>

    <ng-template #body let-prod>
      <tr [pSelectableRow]="prod">
        <td>{{ prod.barcode }}</td>
        <td>{{ prod.name }}</td>
      </tr>
    </ng-template>

    <ng-template #emptymessage>
      <tr>
        <td colspan="2" class="text-center py-6">
          Nenhum produto encontrado.
          <p-button
            text
            size="small"
            icon="pi pi-plus"
            label="Cadastrar novo agora"
            (click)="toggleNewProduct(true)"
          />
        </td>
      </tr>
    </ng-template>
  </p-table>

  <ng-template #footer>
    <p-button
      label="Cancelar"
      severity="secondary"
      (click)="productSelectVisible = false"
    />
  </ng-template>
</p-dialog>


<p-confirmDialog [style]="{ width: '28rem' }"></p-confirmDialog>
